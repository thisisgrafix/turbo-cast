<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream Scanner Feed</title>
    <script>
        // Dynamically load the Cast SDK script
        function loadCastSDK() {
            const script = document.createElement('script');
            script.src = 'https://www.gstatic.com/cast/sdk/libs/sender/1.0/cast_framework.js';
            script.onload = function () {
                // Once SDK is loaded, initialize it
                console.log("Cast SDK Loaded");
                initializeCastSDK();
            };
            script.onerror = function () {
                console.error("Failed to load Cast SDK.");
            };
            document.head.appendChild(script);
        }

        // Function to initialize the Cast SDK
        function initializeCastSDK() {
            if (typeof chrome !== 'undefined' && typeof chrome.cast !== 'undefined') {
                console.log("Cast SDK is available.");
                
                const castContext = cast.framework.CastContext.getInstance();

                // Ensure CastContext is available and log the context
                console.log("Cast Context Initialized:", castContext);

                // Set up CastContext options
                castContext.setOptions({
                    receiverApplicationId: chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID, // Default receiver app
                    autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED // Allow auto-join within the origin
                });

                // Set up the Cast button to request session
                const castButton = document.getElementById("castButton");
                castButton.addEventListener("click", () => {
                    console.log("Requesting session...");
                    castContext.requestSession().then(
                        (session) => {
                            console.log("Session successfully started:", session);
                        },
                        (error) => {
                            console.error("Error requesting session:", error);
                        }
                    );
                });
            } else {
                console.error("Cast SDK is not available. Please check if the Cast SDK script is properly loaded.");
            }
        }

        // Function to cast audio to Google Home
        function castAudio(feedUrl) {
            const castContext = cast.framework.CastContext.getInstance();
            const currentSession = castContext.getCurrentSession();

            // Check if session exists
            if (!currentSession) {
                alert("Please connect to a Google Home first!");
                return;  // Exit the function if no session exists
            }

            // Check if chrome.cast and chrome.cast.media are available
            if (typeof chrome.cast === 'undefined' || typeof chrome.cast.media === 'undefined') {
                console.error("chrome.cast.media is not available.");
                return;
            }

            // Set up the media information for the selected feed
            const mediaInfo = new chrome.cast.media.MediaInfo(feedUrl, 'audio/mp3');
            const request = new chrome.cast.media.LoadRequest(mediaInfo);

            // Load and start the media
            currentSession.loadMedia(request).then(
                () => { console.log('Stream started!'); },
                (error) => { console.error('Failed to load media:', error); }
            );
        }

        // Load the Cast SDK when the page is ready
        window.onload = function() {
            loadCastSDK();  // Dynamically load the Cast SDK script
        };
    </script>
</head>
<body>
    <h1>Broadcastify Scanner Feeds</h1>
    
    <button id="castButton">Cast to Google Home</button>
    
    <h2>Available Feeds</h2>
    <ul>
        <li><button onclick="castAudio('https://broadcastify.cdnstream1.com/12345')">Feed 1</button></li>
        <li><button onclick="castAudio('https://broadcastify.cdnstream1.com/67890')">Feed 2</button></li>
        <!-- Add more feeds here as needed -->
    </ul>
</body>
</html>
