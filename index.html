<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream Scanner Feed</title>
    <script src="https://www.gstatic.com/cast/sdk/libs/sender/1.0/cast_framework.js"></script>
</head>
<body>
    <h1>Broadcastify Scanner Feeds</h1>
    
    <button id="castButton">Cast to Google Home</button>
    
    <h2>Available Feeds</h2>
    <ul>
        <li><button onclick="castAudio('https://broadcastify.cdnstream1.com/12345')">Feed 1</button></li>
        <li><button onclick="castAudio('https://broadcastify.cdnstream1.com/67890')">Feed 2</button></li>
        <!-- Add more feeds here as needed -->
    </ul>

    <script>
        // Wait for the Cast SDK to be ready
        function onCastSDKReady() {
            const castContext = cast.framework.CastContext.getInstance();

            // Ensure Cast SDK is initialized and log the status
            console.log("Cast SDK Initialized:", castContext);

            // CastContext initialization options
            castContext.setOptions({
                receiverApplicationId: chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID, // Default receiver app
                autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED // Allow auto-join within the origin
            });

            // Cast button listener - let user connect to Google Home
            const castButton = document.getElementById("castButton");
            castButton.addEventListener("click", () => {
                console.log("Requesting session...");
                castContext.requestSession().then(
                    (session) => {
                        console.log("Session successfully started:", session);
                    },
                    (error) => {
                        console.error("Error requesting session:", error);
                    }
                );
            });

            // Function to cast audio to Google Home
            function castAudio(feedUrl) {
                const currentSession = castContext.getCurrentSession();

                // Check if session exists
                if (!currentSession) {
                    alert("Please connect to a Google Home first!");
                    return;  // Exit the function if no session exists
                }

                // Check if the chrome.cast.media object is available
                if (typeof chrome.cast === 'undefined' || typeof chrome.cast.media === 'undefined') {
                    console.error("Chrome Cast media API is not available.");
                    return;
                }

                // Set up the media information for the selected feed
                const mediaInfo = new chrome.cast.media.MediaInfo(feedUrl, 'audio/mp3');
                const request = new chrome.cast.media.LoadRequest(mediaInfo);

                // Load and start the media
                currentSession.loadMedia(request).then(
                    () => { console.log('Stream started!'); },
                    (error) => { console.error('Failed to load media:', error); }
                );
            }
        }

        // Ensure the Cast SDK is fully loaded and initialized before proceeding
        if (window.chrome && chrome.cast) {
            onCastSDKReady();
        } else {
            console.error("Cast SDK is not available.");
        }
    </script>
</body>
</html>
